{% extends "base.html" %}
{% block title %}{{art.headline}}{% end %}


{% block extra_js %}

    // hide the submit button on the tags form until a change is made
    $('form#set-tags input[type="submit"]').hide();
    $('form#set-tags input[type="checkbox"]').bind('change',function() {$('form#set-tags input[type="submit"]').show();});


    // set up journal/researcher buttons for google scholar search thingy
    function reescape(str)
    {
      var specials = new RegExp("[.*+?|()\\[\\]{}\\\\]", "g"); // .*+?|()[]{}\
      return str.replace(specials, "\\$&");
    }

    $('.helper form .researcher').each(function(index) {
        var fullname = '"' + $.trim($(this).text()) + '"';

        var cb = $('<input type="checkbox" />').change(function() {
            var cur = $.trim($('#as_sauthors').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = cur + " " + fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_sauthors').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");
    });

    $('.helper form .journal').each(function(index) {
        var fullname = $.trim($(this).text()); 

        var cb = $('<input type="radio" name="j"/>').change(function() {
            var cur = $.trim($('#as_publication').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_publication').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");

    });

{% end %}

{% block main %}
<div id="view">
<header>
<h2><a href="{{art.permalink}}">{{art.headline}}</a></h2>
<span class="pubdate">{{art.pubdate}}</span> - <span class="publication">{% module domain(art.permalink) %}</span>

</header>
<div class="body">

{% for w in [t for t in art.tags if t.kind==TagKind.WARNING] %}
<div class="warning-label"><img src="{{w.big_icon()}}"/><b>WARNING</b><br/>{{w.description}}</div>
{% end %}

{% if scrape_err %}
<p>Sorry, but there was a problem fetching the article text: {{scrape_err}}</p>
{% else %}
{% raw article_content %}
{% end %}
</div>
</div>

<div id="tools">

  <div class="sources">
    <h2>Sources</h2>
    {% if art.sources %}
    <ul>
    {% for s in art.sources %}
    {% module source(s, element_type="li") %}
    {% end %}
    </ul>
    {% else %}
    <p>None<p>
    {% end %}
  </div>


{% module tool_addsource(art, add_source_form, institutions, journals, researchers) %}

  <div class="helper act tags">
    {% if current_user %}

    <h2>Edit Tags</h2>
    <form id="set-tags" action="/art/{{art.id}}/settags" method="post">

    {% for t in [foo for foo in all_tags if foo.kind==TagKind.WARNING] %}
      <input type="checkbox" id="tag-{{t.name}}" name="tags" value="{{t.name}}" {% if t in art.tags %}checked{% end %}/>
      <label for="tag-{{t.name}}"><img src="{{t.med_icon()}}" title="{{t.description}}" alt="{{t.name}}"/></label>
    {% end %}

    <div style="width:2em; display: inline-block;"></div>

    {% for t in [foo for foo in all_tags if foo.kind==TagKind.GENERAL] %}
      <input type="checkbox" id="tag-{{t.name}}" name="tags" value="{{t.name}}" {% if t in art.tags %}checked{% end %}/>
      <label for="tag-{{t.name}}"><img src="{{t.med_icon()}}" title="{{t.description}}" alt="{{t.name}}"/></label>
    {% end %}

    <div style="width:2em; display: inline-block;"></div>

    {% for t in [foo for foo in all_tags if foo.kind==TagKind.ADMIN] %}
      <input type="checkbox" id="tag-{{t.name}}" name="tags" value="{{t.name}}" {% if t in art.tags %}checked{% end %}/>
      <label for="tag-{{t.name}}"><img src="{{t.med_icon()}}" title="{{t.description}}" alt="{{t.name}}"/></label>
    {% end %}

    <br/>
    <input type="submit" name="submit" value="Update tags"/> 
    </form>
    {% else %}
    <h2>Tags</h2>
{% for t in art.tags %}
      <img src="{{t.med_icon()}}" title="{{t.description}}" alt="{{t.name}}"/>
{% end %}
    <br/>
    <a href="/login?next=/art/{{art.id}}">Log in</a> to edit tags
    {% end %}
  </div>

  <div class="act">
   <h2>Chatter</h2>
    <ul>
{% for cmt in art.comments %}
    <li>{{cmt.author.username}}: {{cmt.content}}</li>
{% end %}
    </ul>
    {% if current_user %}
    <form action="/art/{{art.id}}/postcomment" method="POST">
    <input type="text" name="msg" />
    <input type="submit" value="Post comment"/>
    </form>
    {% else %}
    <a href="/login?next=/art/{{art.id}}">Log in</a> to add a comment
    {% end %}
  </div>


</div> <!-- /#tools -->
{% end %}

