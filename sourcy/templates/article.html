{% extends "base.html" %}
{% block title %}{{art.headline}}{% end %}


{% block extra_js %}


// ugly gubbins for showing/hiding forms
$('.add + .add-source').hide();

$('.add').click(function() {
    /* hide all others */
    $('.add + .add-source').slideUp(200,function() {
        $(this).prev('.add').show();
    });

    var button = $(this);
    button.hide();
    /* show just one */
    $(this).next('.add-source').slideDown(200);
    return false;
});

$('.add-source .cancel').click(function() {
    var button = $(this).closest('.add-source').prev('.add');
    $(this).closest('.add-source').slideUp( 200, function() {
        button.show();
    });
    return false;
});


// when a source is added, insert it into the appropriate list
pubsub.source_added.add(function(new_src) {
  var kinds = {paper: '.srclist-paper', pr: '.srclist-pr', other: '.srclist-other'};
  var destlist = kinds[new_src.kind];

    console.log(new_src);

  $(new_src.html)
    .hide()
    .css('opacity',0.0)
    .appendTo($(destlist))
    .slideDown('fast')
    .animate({opacity: 1.0});

    // reset the add-source boxes and buttons
    $('.add-source').hide();
    $('.add-source .cancel').hide();
    $('.add').show();

});

{% end %}

{% block main %}

<div class="l-row">

<div class="l-col66">
<div id="view">
<div class="fullart">

<header>
<h2 class="fullart-headline"><a href="{{art.permalink}}">{{art.headline}}</a></h2>
<span class="pubdate">{{art.pubdate}}</span> - <span class="publication">{% module domain(art.permalink) %}</span>
</header>

<div class="body">

{% for w in [t for t in art.tags if t.kind==TagKind.WARNING] %}
<div class="warning-label"><img src="{{w.big_icon()}}"/><b>WARNING</b><br/>{{w.description}}
      {% if current_user %}
      <form style="float:right;" action="/art/{{art.id}}/deltag" method="post">
        {% raw xsrf_form_html() %}
        <input type="hidden" name="tag" value="{{w.name}}"/>
        <input class="btn" type="submit" value="Remove" />
      </form>
      {% end %}
</div>
{% end %}


{% if scrape_err %}
<p>Sorry, but there was a problem fetching the article text: {{scrape_err}}</p>
<p>if you'd like, you can paste the text in here manually:</p>
<form action="/art/{{art.id}}" method="post">
{% raw xsrf_form_html() %}
<textarea name="text">
</textarea>
<input type="submit" />
</form>
{% else %}
{% raw article_content %}
{% end %}
</div>


</div> <!-- end .fullart -->
</div> <!-- end #view -->
</div>

<div class="l-col33 sidebar">
<div id="tools">

  <div class="tool sources">
    <header>
    <h2>Sources</h2>
    </header>

    <div class="bod">
    <h3>Academic papers</h3>
    <ul class="srclist srclist-paper">
    {% for src in art.papers() %}{% module source(src, container='li') %}{% end %}
    </ul>

    <a class="btn add" href="/art/{{art.id}}/paper/add" method="GET">Add</a>
    <div class="add-source">
    <h3>Add paper</h3><a class="cancel" href="/art/{{art.id}}">cancel</a>
    {% module add_paper(art, add_paper_form) %}
    {% module helper_paper(art,journals,institutions,researchers) %}
    </div>

    <br/>
    <br/>
    <h3>Press releases</h3>
    <ul class="srclist srclist-pr">
    {% for src in art.press_releases() %}{% module source(src, container='li') %}{% end %}
    </ul>

    <a class="btn add" href="/art/{{art.id}}/pr/add" method="GET">Add</a>
    <div class="add-source">
    <h3>Add press release</h3><a class="cancel" href="/art/{{art.id}}">cancel</a>
    {% module add_pr(art, add_pr_form) %}
    {% module helper_pr(art,journals,institutions,researchers) %}
    </div>


    <br/>
    <br/>
    <h3>Other links</h3>
    <ul class="srclist srclist-other">
    {% for src in art.other_links() %}{% module source(src, container='li') %}{% end %}
    </ul>

    <a class="btn add" href="/art/{{art.id}}/other/add" method="GET">Add</a>
    <div class="add-source">
    <h3>Add other link</h3><a class="cancel" href="/art/{{art.id}}">cancel</a>
    {% module add_other(art, add_other_form) %}
    {% module helper_other(art,journals,institutions,researchers) %}
    </div>

    </div>  <!-- end .bod -->
  </div>

{% if art.needs_sourcing %}
 <div class="act tool">
    {% if len(art.sources)>0 %}
    Have all the sources for this article have been added?
    {% else %}
    Think this article doesn't need any sources?
    {% end %}
    <form action="/art/{{art.id}}/mark-sourced" method="post">
    {% raw xsrf_form_html() %}
    <input class="btn" type="submit" value="Mark it sourced" />
    </form>
 </div>
{% else %}
  <div class="act tool"><img src="/static/tag_med/tick.png" />This article has been marked as sourced - all sources tracked down and added.
    <form action="/art/{{art.id}}/mark-unsourced" method="post">
    {% raw xsrf_form_html() %}
    <input class="btn" type="submit" value="disagree" />
    </form>
  </div>
{% end %}



{% if len(art.help_reqs)>0 %}
  <div class="act tool"><img src="/static/tag_med/help.png" />{% module user(art.help_reqs[0].user, True) %} asked for help on this article
    <form action="/art/{{art.id}}/close-helpreq" method="post">
    {% raw xsrf_form_html() %}
    <input class="btn" type="submit" value="Close help request" />
    </form>
  </div>

{% else %}

  <div class="act tool">
    Having trouble tracking down sources for this article?
    <form action="/art/{{art.id}}/open-helpreq" method="post">
    {% raw xsrf_form_html() %}
    <input class="btn" type="submit" value="Ask for help" />
    </form>
  </div>

{% end %}




<div class="tool">
<header>
  <h2>Recent activity</h2>
</header>
  <div class="bod">
    <ul class="act-list">
{% for act in recent_actions %}
      <li class="act">{% module action(act, show_article=False, user_display='s') %}</li>
{% end %}
    </ul>
  </div>
</div> <!-- /.tool -->

<div class="tool">
  <header>
    <h2>Comments</h2>
  </header>
  <div class="bod">
    <ul class="act-list">
{% for act in recent_comments %}
      <li class="act">{% module action(act, show_article=False) %}</li>
{% end %}
    </ul>
    {% if current_user %}
    <h3>Leave a reply</h3>
    <form action="/art/{{art.id}}/postcomment" method="POST">
    {% raw xsrf_form_html() %}
    <textarea name="msg" />
    </textarea>
    <input type="submit" value="Add comment"/>
    </form>
    {% else %}
    <a href="/login?next=/art/{{art.id}}">Log in</a> to add a comment
    {% end %}
  </div>
</div> <!-- /.tool -->



</div> <!-- /#tools -->

</div>
</div> <!-- end .l-row -->
{% end %}

