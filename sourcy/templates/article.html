{% extends "base.html" %}
{% block title %}{{art.headline}}{% end %}

{% block extra_js %}

    function reescape(str)
    {
      var specials = new RegExp("[.*+?|()\\[\\]{}\\\\]", "g"); // .*+?|()[]{}\
      return str.replace(specials, "\\$&");
    }

    $('.helper form .researcher').each(function(index) {
        var fullname = '"' + $.trim($(this).text()) + '"';

        var cb = $('<input type="checkbox" />').change(function() {
            var cur = $.trim($('#as_sauthors').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = cur + " " + fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_sauthors').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");
    });

    $('.helper form .journal').each(function(index) {
        var fullname = $.trim($(this).text()); 

        var cb = $('<input type="radio" name="j"/>').change(function() {
            var cur = $.trim($('#as_publication').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_publication').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");

    });

{% end %}

{% block main %}
<div id="view">
<header>
<h2><a href="{{art.permalink}}">{{art.headline}}</a></h2>
<span class="pubdate">{{art.pubdate}}</span> - <span class="publication">{% module domain(art.permalink) %}</span>

</header>
<div class="body">

{% if warnings %}
{% for w in warnings %}
<div class="warning-label"><img src="{{w[1]}}"/><b>WARNING</b><br/>{{w[0]}}</div>
{% end %}
{% end %}

{% if scrape_err %}
<p>Sorry, but there was a problem fetching the article text: {{scrape_err}}</p>
{% else %}
{% raw article_content %}
{% end %}
</div>
</div>

<div id="tools">

  <div class="sources">
    <h2>Sources</h2>
    {% if art.sources %}
    <ul>
    {% for s in art.sources %}
    {% module source(s, element_type="li") %}
    {% end %}
    </ul>
    {% else %}
    <p>None<p>
    {% end %}
  </div>

  <div class="helper helpful-links">
      <h2>Helpful links</h2>
  {% if institutions %}
  <h3>Institutions</h3>
  <ul>
  {% for r in institutions %}
  <li><span class="hilite institution">{{r[0]}}</span> (<a href="{{r[1]}}">homepage</a>)</li>
  {% end %}
  </ul>
  {% end %}

  {% if journals %}
  <h3>Journals</h3>
  <ul>
  {% for r in journals %}
  <li><span class="hilite journal">{{r[0]}}</span> (<a href="{{r[1]}}">homepage</a>)</li>
  {% end %}
  </ul>
  {% end %}
  <p>(add a missing <a href="/addjournal">journal</a> or <a href="/addinstitution">institution</a>)</p>
  </div>

  <div class="helper addsource">
      <h2>Add a source</h2>
      {% if current_user %}
      <form action="/art/{{art.id}}/addsource" method="post">
      {% module form(add_source_form) %}
      <input type="submit" name="submit" value="add" />
      </form>
      {% else %}
      <a href="/login?next=/art/{{art.id}}">Log in</a> to add a source
      {% end %}
  </div>

  <div class="helper">
  <h2>Search for papers</h2>


  <form action="http://scholar.google.co.uk/scholar" method="GET" target="_blank">
      <label for="as_sauthors">written by:</label>
      <input type="text" name="as_sauthors" id="as_sauthors"/>
      <ul>
          {% for r in researchers %}
          <li><span class="hilite researcher">{{r['name']}}</span></li> <!-- {{r['search_value']}} -->
          {% end %}<br/>
      </ul>

      <label for="as_publication">published in:</label>
      <input type="text" name="as_publication" id="as_publication"/><br/>
      <ul>
          {% for j in journals %}
          <li><span class="hilite journal">{{j[0]}}</span></li>
          {% end %}
      </ul>

      <label for="as_q">keywords:</label>
      <input type="text" name="as_q" id="as_q" /><br/>
      <input type="submit" value="Search" name="btnG" /> (opens in a new window)
  </form>
  </div>

  <div class="helper tags">
      <h2>Tags</h2>
      {% if art.tags %}
      <ul>
      {% for tag in art.tags %}
      {% module tag(tag, element_type="li") %}
      {% end %}
      </ul>
      {% end %}

      {% if current_user %}
      <form action="/art/{{art.id}}/addtag" method="POST">
      {% for field in add_tag_form %}
      {% module formfield(field) %}
      {% end %}
      <input type="submit" value="Add"/>
      </form>
      {% else %}
      <a href="/login?next=/art/{{art.id}}">Log in</a> to add a tag
      {% end %}
  </div>


</div> <!-- /#tools -->
{% end %}

