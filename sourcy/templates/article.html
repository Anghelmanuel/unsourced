{% extends "base.html" %}
{% block title %}{{art.headline}}{% end %}

{% block extra_js %}

    function reescape(str)
    {
      var specials = new RegExp("[.*+?|()\\[\\]{}\\\\]", "g"); // .*+?|()[]{}\
      return str.replace(specials, "\\$&");
    }

    $('.helper form .researcher').each(function(index) {
        var fullname = '"' + $.trim($(this).text()) + '"';

        var cb = $('<input type="checkbox" />').change(function() {
            var cur = $.trim($('#as_sauthors').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = cur + " " + fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_sauthors').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");
    });

    $('.helper form .journal').each(function(index) {
        var fullname = $.trim($(this).text()); 

        var cb = $('<input type="radio" name="j"/>').change(function() {
            var cur = $.trim($('#as_publication').val());
            var pat = new RegExp(reescape(fullname),"ig");
            if(this.checked) {
               cur = fullname;
            } else {
               cur = cur.replace(pat,'');
            }
            $('#as_publication').val(cur);
        });
        cb.prependTo(this);
        $(this).wrap("<label/>");

    });

{% end %}

{% block main %}
<div id="view">
<header>
<h2><a href="{{art.permalink}}">{{art.headline}}</a></h2>
<span class="pubdate">{{art.pubdate}}</span> - <span class="publication">{% module domain(art.permalink) %}</span>

</header>
<div class="body">
{% if scrape_err %}
<p>Sorry, but there was a problem fetching the article text: {{scrape_err}}</p>
{% else %}
{% raw article_content %}
{% end %}
</div>
</div>

<div id="tools">

  <div class="sources">
    <h2>Sources</h2>
    {% if sources %}
    <ul>
    {% for s in sources %}
      <li><a href="{{s.url}}">{{s.url}}</a></li>
    {% end %}
    </ul>
    {% else %}
    <p>None<p>
    {% end %}
  </div>

  <div class="helper addsource">
    <h2>Add an academic paper</h2>
    <form action="/edit" method="post">
        <label for="url">URL of paper</label>
        <input type="hidden" name="art_id" value="{{art.id}}"/>
        <input type="text" name="url" id="url" columns="80"/><br/>
        <input type="submit" value="submit"/><br/>
        <span class="helptext"><a href="/academicpapers#doi">what's a DOI?</a> <a href="/academicpapers#linking">guidelines on linking to academic papers</a></span><br/>
    </form>
  </div>

  <div class="helper">
  <h2>Search for papers</h2>


  <form action="http://scholar.google.co.uk/scholar" method="GET" target="_blank">
      <label for="as_sauthors">written by:</label>
      <input type="text" name="as_sauthors" id="as_sauthors"/>
      <ul>
          {% for r in researchers %}
          <li><span class="hilite researcher">{{r['name']}}</span></li> <!-- {{r['search_value']}} -->
          {% end %}<br/>
      </ul>

      <label for="as_publication">published in:</label>
      <input type="text" name="as_publication" id="as_publication"/><br/>
      <ul>
          {% for j in journals %}
          <li><span class="hilite journal">{{j[0]}}</span></li>
          {% end %}
      </ul>

      <label for="as_q">keywords:</label>
      <input type="text" name="as_q" id="as_q" /><br/>
      <input type="submit" value="Search" name="btnG" /> (opens in a new window)
  </form>
  </div>


  <div class="helper helpful-links">
      <h2>Helpful links</h2>
  {% if institutions %}
  <h3>Institutions</h3>
  <ul>
  {% for r in institutions %}
  <li><span class="hilite institution">{{r[0]}}</span> (<a href="{{r[1]}}">homepage</a>)</li>
  {% end %}
  </ul>
  {% end %}

  {% if journals %}
  <h3>Journals</h3>
  <ul>
  {% for r in journals %}
  <li><span class="hilite journal">{{r[0]}}</span> (<a href="{{r[1]}}">homepage</a>)</li>
  {% end %}
  </ul>
  {% end %}
  <p>(add a missing <a href="/addjournal">journal</a> or <a href="/addinstitution">institution</a>)</p>
  </div>


</div> <!-- /#tools -->
{% end %}

